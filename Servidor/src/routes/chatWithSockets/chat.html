<!DOCTYPE html>
<html class="FullScreenObject">
    <head>
        <title>Chat En Clase</title>
        <link rel="stylesheet" href="/styles.css">
        <style>
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100%;
                font-family: Arial, sans-serif;
            }
        </style>
    </head>
    
    <body class="FullScreenObject">
        <div id="LoginContainer" style="padding: 20px; text-align: center;">
            <h2>Login</h2>
            <div>Username: </div>
            <input type="text" id="UsernameInput" style="margin-bottom: 10px; padding: 5px;"/>
            <div>Password: </div>
            <input type="password" id="PasswordInput" style="margin-bottom: 10px; padding: 5px;"/>
            <p id="LoginErrorMessage" class="ErrorMessage"></p>
            <button onclick="TryLogin()" style="padding: 10px 20px;">Login</button>
        </div>

        <div class="ChatContainer" id="ChatContainer" style="display: none; height: 100%; display: flex; flex-direction: column;">
            <div id="MessagesContainer" class="MessagesContainer" style="flex: 1; overflow-y: auto; padding: 10px;">
                <!-- Los mensajes aparecerán aquí -->
            </div>
            <div class="InputContainer" style="padding: 10px; background: #f0f0f0; display: flex; align-items: center;">
                <div style="margin-right: 10px;">Message Box:</div>
                <input type="text" id="MessageInput" class="MessageInput" style="flex: 1; padding: 5px;"/>
                <button onclick="SendMessage()" class="MessageButton" style="margin-left: 10px; padding: 5px 15px;">Send</button>
            </div>

            <div id="UserInfo" hidden>
                <p id="LoggedUser"></p>
                <button onclick="Logout()">Logout</button>
            </div>

            <div id="RoomsContainer">
                <ul id="RoomsList"></ul>
            </div>
        </div>

    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var loginContainer = document.getElementById("LoginContainer");
        var usernameField = document.getElementById("UsernameInput");
        var passwordField = document.getElementById("PasswordInput");
        var loginErrorMessage = document.getElementById("LoginErrorMessage");

        var chatContainer = document.getElementById("ChatContainer");
        var messageContainer = document.getElementById("MessagesContainer");
        var inputField = document.getElementById("MessageInput");

        // Función CORREGIDA - añade parámetro messageData
        function CreateMessageWithData(messageData) {
            var msgParagraph = document.createElement("p");
            msgParagraph.textContent = messageData.username + ": " + messageData.text;

            if(messageData.username == usernameField.value) {
                msgParagraph.classList.add("MyMessage");
            } else {
                msgParagraph.classList.add("OthersMessage");
            }

            messageContainer.appendChild(msgParagraph);
            // Auto-scroll al último mensaje
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        socket.on("ServerMessageToClient", (messageData) => {
            CreateMessageWithData(messageData);
        });

        socket.on("ServerResponseRequestMessageListToClient", (msgDataList) => {
            messageContainer.innerHTML = ""; // Limpiar contenedor

            for(var i = 0; i < msgDataList.length; i++) {
                CreateMessageWithData(msgDataList[i]);
            }
        });

        function SendMessage() {
            if(inputField.value.trim() !== "") {
                var username = usernameField.value;
                var text = inputField.value;

                var messageData = {
                    username: username,
                    text: text
                };

                socket.emit("ClientMessageToServer", messageData);
                inputField.value = "";
                inputField.focus();
            }
        }

        usernameField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
               TryLogin();
            }
        });
        passwordField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                TryLogin();
            }
        });

        // Permitir enviar con Enter
        inputField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                SendMessage();
                //TryLogin();
            }
        });

        // Solicitar mensajes anteriores al conectar
        socket.emit("ClientRequestMessageListToServer");

        function TryLogin() {
            loginErrorMessage.textContent = "";

            if(usernameField.value.trim() === "" || passwordField.value.trim() === "") {
                loginErrorMessage.textContent = "User or password is blank";
                return;
            }

            var loginData = {
                username: usernameField.value,
                password: passwordField.value
            };

            document.getElementById('UserInfo').hidden = false

            socket.emit("LoginRequest", loginData);
        }

        socket.on("LoginResponse", (loginResponseData) => {
            console.log("LoginResponse recibido:", loginResponseData);
            
            // CORRECCIÓN: "statues" vs "status" (hay un typo en chat.js)
            if(loginResponseData.status === "error" || loginResponseData.statues === "error") {
                var errorMessage = loginResponseData.message || "Unknown error";
                loginErrorMessage.textContent = errorMessage;
                return;
            }

            // Login exitoso
            loginContainer.style.display = "none";
            chatContainer.style.display = "flex";
            inputField.focus();
        
        });

        // Conectar cuando se carga la página
        socket.on("connect", () => {
            console.log("Conectado al servidor");
        });



          // tras LoginResponse success:
            // LoggedUser.textContent = `Logged as ${usernameField.value} (id=${loginResponseData.id})`;
            // UserInfo.hidden = false;

            function Logout() {
                UserInfo.hidden = true;
                chatContainer.hidden = true;
                loginContainer.hidden = false;
                socket.emit('leaveRoom', { roomId: currentRoomId, playerId: loginResponseData.id });
                currentRoomId = null;
            }

            // teclado: Enter envía mensaje, ESC sale de la sala
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') SendMessage();
                if (e.key === 'Escape' && currentRoomId) Logout();
            });

            // listado de salas: pedir al servidor y renderizar
            socket.on('roomsInfo', (rooms) => {
                RoomsList.innerHTML = '';
                rooms.forEach(r => {
                const li = document.createElement('li');
                li.textContent = `Room ${r.id}: ${r.name}`;
                const btn = document.createElement('button');
                btn.textContent = 'Join';
                btn.onclick = () => {
                    currentRoomId = r.id;
                    socket.emit('joinRoom', JSON.stringify({ roomId: r.id, playerId: loginResponseData.id, playerName: usernameField.value }));
                };
                li.appendChild(btn);
                RoomsList.appendChild(li);
                });
            });

            // pedir salas al cargar
            socket.emit('requestRooms');
    </script>
</html>