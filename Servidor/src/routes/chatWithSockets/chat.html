<!DOCTYPE html>
<html class="FullScreenObject">
  <head>
    <title>Chat En Clase</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <header></header>

  <body class="FullScreenObject">
    <div id="LoginContainer">
      <div>Username: </div>
      <input type="text" id="UsernameInput" />
      <div>Password: </div>
      <input type="password" id="PasswordInput" />
      <p id="LoginErrorMessage" class="ErrorMessage"></p>
      <button onclick="TryLogin()">Try Login</button>
    </div>

    <!-- Bloque de usuario: inicialmente oculto -->
    <div id="UserInfo" hidden>
      <p id="LoggedUser"></p>
      <button onclick="Logout()">Logout</button>
    </div>

    <!-- Chat: inicialmente oculto -->
    <div class="ChatContainer" id="ChatContainer" hidden>
      <div id="MessagesContainer" class="MessagesContainer"></div>
      <div class="InputContainer">
        <div>Message Box: </div>
        <input type="text" id="MessageInput" />
        <button onclick="SendMessage()" class="MessageButton">Send</button>
      </div>
    </div>
  </body>

  <footer></footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Referencias UI
    const loginContainer = document.getElementById("LoginContainer");
    const usernameField = document.getElementById("UsernameInput");
    const passwordField = document.getElementById("PasswordInput");
    const loginErrorMessage = document.getElementById("LoginErrorMessage");

    const userInfo = document.getElementById("UserInfo");
    const loggedUser = document.getElementById("LoggedUser");

    const chatContainer = document.getElementById("ChatContainer");
    const messageContainer = document.getElementById("MessagesContainer");
    const inputField = document.getElementById("MessageInput");

    // Estado de sesión y sala
    let currentUserId = null;
    let currentRoomId = null;

    // Opcional: registrar tipo de cliente
    if (socket && socket.emit) {
      socket.emit("registerClientType", "web");
    }

    function TryLogin() {
      loginErrorMessage.textContent = "";

      if (!usernameField.value || !passwordField.value) {
        loginErrorMessage.textContent = "User or password is blank";
        return;
      }

      const loginData = {
        username: usernameField.value,
        password: passwordField.value,
      };

      socket.emit("LoginRequest", loginData);
    }

    socket.on("LoginResponse", (loginResponseData) => {
      // Soporta tanto 'status' como 'statues' por compatibilidad con el backend actual
      const isSuccess =
        loginResponseData &&
        (loginResponseData.status === "success" ||
          loginResponseData.statues === "success");

      if (!isSuccess) {
        const errorMessage =
          (loginResponseData && loginResponseData.message) || "Unknown";
        loginErrorMessage.textContent = errorMessage;
        return;
      }

      // Éxito
      currentUserId = loginResponseData.id;
      loggedUser.textContent = `Usuario: ${usernameField.value} (id: ${currentUserId})`;

      userInfo.hidden = false;
      loginContainer.hidden = true;
      chatContainer.hidden = false;

      // Si quieres unirte automáticamente a una sala por defecto, descomenta:
      // currentRoomId = "1";
      // socket.emit(
      //   "joinRoom",
      //   JSON.stringify({
      //     roomId: currentRoomId,
      //     playerId: currentUserId,
      //     playerName: usernameField.value,
      //   })
      // );
    });

    function Logout() {
      // Si estás en una sala, abandónala
      if (currentRoomId) {
        socket.emit(
          "leaveRoom",
          JSON.stringify({ roomId: currentRoomId, playerId: currentUserId })
        );
      }

      // Limpiar estado y UI
      currentUserId = null;
      currentRoomId = null;
      usernameField.value = "";
      passwordField.value = "";
      messageContainer.innerHTML = "";

      userInfo.hidden = true;
      chatContainer.hidden = true;
      loginContainer.hidden = false;
    }

    function SendMessage() {
      if (inputField.value) {
        const messageData = {
          username: usernameField.value,
          text: inputField.value,
        };
        socket.emit("ClientMessageToServer", messageData);
        inputField.value = "";
      }
    }

    function CreateMessageWithData(messageData) {
      const msgParagraph = document.createElement("p");
      msgParagraph.textContent = messageData.text;

      if (messageData.username === usernameField.value) {
        msgParagraph.classList.add("MyMessage");
      } else {
        msgParagraph.classList.add("OthersMessage");
      }

      messageContainer.appendChild(msgParagraph);
    }

    socket.on("ServerMessageToClient", (messageData) => {
      CreateMessageWithData(messageData);
    });

    socket.on("ServerResponseRequestMessageListToClient", (msgDataList) => {
      messageContainer.innerHTML = "";
      for (const messageData of msgDataList) {
        CreateMessageWithData(messageData);
      }
    });

    // Cargar historial al entrar
    socket.emit("ClientRequestMessageListToServer");

    // Atajos de teclado
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") SendMessage();
      if (e.key === "Escape") Logout();
    });
  </script>
</html>