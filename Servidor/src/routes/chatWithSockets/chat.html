<!DOCTYPE html>
<html class = FullScreenObject>
    <head>
        <title>Chat En Clase</title>
        <link rel="stylesheet" href="/styles.css">
    </head>
    
    <header></header>
    
    <body class = FullScreenObject>
        <div id="LoginContainer">
            <div>Username: </div>
            <input type="text" id="UsernameInput"/>
            <div>Password: </div>
            <input type="password" id="PasswordInput"/>
            <p id="LoginErrorMessage" class="ErrorMessage"></p>
            <button onclick="TryLogin()">Try Login</button>
        </div>

        <!-- User info + Logout button (añadido) -->
        <div id="UserInfo" hidden>
            <p id="LoggedUser"></p>
            <button id="LogoutBtn" onclick="Logout()">Logout</button>
        </div>

        <!-- Rooms UI -->
        <div id="RoomsContainer" hidden>
            <h3>Rooms</h3>
            <div>
                <input type="text" id="RoomNameInput" placeholder="New room name"/>
                <button onclick="CreateRoom()">Create Room</button>
            </div>
            <div id="RoomList"></div>
        </div>

        <div class="ChatContainer" id="ChatContainer" hidden>
            <!-- Header de chat con Leave Room (añadido) -->
            <div class="ChatHeader">
                <span id="CurrentRoomLabel"></span>
                <button id="LeaveRoomBtn" class="LogoutButton" onclick="LeaveRoom()">Leave room</button>
            </div>

            <div id="MessagesContainer" class ="MessagesContainer"></div>
            <div class="InputContainer">
                <div>Message Box: </div>
                <input type="text" id="MessageInput"/>
                <button onclick="SendMessage()" class="MessageButton">Send</button>
            </div>
        </div>
    </body>
    
    <footer></footer>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        var socket = io();

        var loginContainer = document.getElementById("LoginContainer");
        var usernameField = document.getElementById("UsernameInput");
        var passwordField = document.getElementById("PasswordInput");
        var loginErrorMessage = document.getElementById("LoginErrorMessage");

        var userInfo = document.getElementById("UserInfo");
        var loggedUserLabel = document.getElementById("LoggedUser");

        var roomsContainer = document.getElementById("RoomsContainer");
        var roomNameInput = document.getElementById("RoomNameInput");
        var roomList = document.getElementById("RoomList");

        var chatContainer = document.getElementById("ChatContainer");
        var currentRoomLabel = document.getElementById("CurrentRoomLabel");

        var messageContainer = document.getElementById("MessagesContainer");
        var inputField = document.getElementById("MessageInput");

        var currentUser = { id: null, username: null };
        var currentRoomId = null;

        function CreateMessageWithData(messageData){
            var text = messageData.text || messageData.content || "";
            var senderUsername = messageData.username || (messageData.user_id ? ("user#" + messageData.user_id) : "unknown");

            var msgParagraph = document.createElement("p");
            msgParagraph.textContent = senderUsername + ": " + text;

            if(senderUsername === usernameField.value){
                msgParagraph.classList.add("MyMessage");
            }else {
                msgParagraph.classList.add("OthersMessage");
            }

            messageContainer.appendChild(msgParagraph);
        }

        socket.on("ServerMessageToClient", (messageData) => {
            CreateMessageWithData(messageData);
        });

        socket.on("ServerResponseRequestMessageListToClient", (msgDataList) => {
            messageContainer.textContent = "";
            for(messageData of msgDataList){
                CreateMessageWithData(messageData);
            }
        });

        function SendMessage(){
            if(!currentRoomId){
                alert("Join a room first.");
                return;
            }
            if(inputField.value){
                var text = inputField.value;
                var messageData = {
                    roomId: currentRoomId,
                    content: text
                };
                socket.emit("ClientMessageToServer", messageData);
                inputField.value = "";
            }
        }

        // Rooms rendering
        socket.on("ChatRoomsData", (rooms) => {
            roomList.textContent = "";
            if(!rooms || rooms.length === 0){
                var p = document.createElement("p");
                p.textContent = "No rooms available.";
                roomList.appendChild(p);
                return;
            }

            var ul = document.createElement("ul");
            rooms.forEach(r => {
                var li = document.createElement("li");
                li.textContent = `#${r.id} - ${r.name}`;
                
                var btn = document.createElement("button");
                btn.textContent = "Join";
                btn.onclick = () => JoinRoom(r.id);

                li.appendChild(btn);
                ul.appendChild(li);
            });
            roomList.appendChild(ul);
        });

        function JoinRoom(roomId){
            socket.emit("JoinRoomRequest", { roomId: roomId });
        }

        socket.on("JoinRoomResponse", (data) => {
            if(data.status === "success"){
                currentRoomId = data.roomId;
                chatContainer.hidden = false;
                currentRoomLabel.textContent = "Room #" + currentRoomId;
                socket.emit("ClientRequestMessageListToServer", { roomId: currentRoomId });
            }else{
                alert(data.message || "Join room failed");
            }
        });

        function CreateRoom(){
            var name = (roomNameInput.value || "").trim();
            if(!name){
                alert("Room name is required");
                return;
            }
            socket.emit("CreateRoomRequest", { name: name });
        }

        socket.on("CreateRoomResponse", (res) => {
            if(res.status === "success"){
                roomNameInput.value = "";
                // El servidor emitirá ChatRoomsData con el listado actualizado
            }else{
                alert(res.message || "Create room failed");
            }
        });

        // Petición de mensajes global legacy
        socket.emit("ClientRequestMessageListToServer");

        function TryLogin(){
            loginErrorMessage.textContent = "";

            if(usernameField.value == "" || passwordField.value == ""){
                loginErrorMessage.textContent = "User or password is blank";
            }

            var loginData = {
                username: usernameField.value,
                password: passwordField.value
            };

            socket.emit("LoginRequest", loginData);
        }

        socket.on("LoginResponse", (loginResponseData) => {
            
            if(loginResponseData.status == "error"){
                var errorMessage = loginResponseData.message || "Unknown";
                loginErrorMessage.textContent = errorMessage;
                return;
            }

            currentUser.id = loginResponseData.id;
            currentUser.username = loginResponseData.username || usernameField.value;

            loggedUserLabel.textContent = "Logged in as: " + currentUser.username;
            userInfo.hidden = false;

            loginContainer.hidden = true;
            roomsContainer.hidden = false;

            console.log(loginResponseData);
        });

        // Añadido: salir de la sala actual
        function LeaveRoom() {
            if (!currentRoomId) return;
            socket.emit("leaveRoom", JSON.stringify({ roomId: currentRoomId, playerId: currentUser.id }));
            chatContainer.hidden = true;
            currentRoomLabel.textContent = "";
            currentRoomId = null;
            messageContainer.innerHTML = "";
        }

        // Añadido: logout del usuario
        function Logout() {
            // Si está en una sala, sale primero
            if (currentRoomId) {
                LeaveRoom();
            }

            // Evento opcional hacia servidor (si existe handler)
            socket.emit("LogoutRequest", { userId: currentUser.id });

            // Reset de UI y estado
            userInfo.hidden = true;
            chatContainer.hidden = true;
            roomsContainer.hidden = true;

            loginContainer.hidden = false;

            currentUser.id = null;
            currentUser.username = null;

            usernameField.value = "";
            passwordField.value = "";
            messageContainer.innerHTML = "";
        }

    </script>
</html>