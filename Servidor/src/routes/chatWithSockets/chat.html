<!DOCTYPE html>
<html class="FullScreenObject">
  <head>
    <title>Chat En Clase</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <header></header>

  <body class="FullScreenObject">
    <div id="LoginContainer">
      <div>Username: </div>
      <input type="text" id="UsernameInput" />
      <div>Password: </div>
      <input type="password" id="PasswordInput" />
      <p id="LoginErrorMessage" class="ErrorMessage"></p>
      <button onclick="TryLogin()">Try Login</button>
    </div>

    <div id="UserInfo" hidden>
      <p id="LoggedUser"></p>
      <button onclick="Logout()">Logout</button>
    </div>

    <div id="RoomsContainer" hidden>
      <h3>Salas disponibles</h3>
      <ul id="RoomsList"></ul>
    </div>

    <div class="ChatContainer" id="ChatContainer" hidden>
      <div class="ChatHeader">
        <span id="CurrentRoomLabel"></span>
        <button id="LeaveRoomBtn" class="LogoutButton" onclick="LeaveRoom()">Leave room</button>
      </div>
      <div id="MessagesContainer" class="MessagesContainer"></div>
      <div class="InputContainer">
        <div>Message Box: </div>
        <input type="text" id="MessageInput" />
        <button onclick="SendMessage()" class="MessageButton">Send</button>
      </div>
    </div>
  </body>

  <footer></footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Referencias UI
    const loginContainer = document.getElementById("LoginContainer");
    const usernameField = document.getElementById("UsernameInput");
    const passwordField = document.getElementById("PasswordInput");
    const loginErrorMessage = document.getElementById("LoginErrorMessage");

    const userInfo = document.getElementById("UserInfo");
    const loggedUser = document.getElementById("LoggedUser");

    const roomsContainer = document.getElementById("RoomsContainer");
    const roomsList = document.getElementById("RoomsList");

    const chatContainer = document.getElementById("ChatContainer");
    const currentRoomLabel = document.getElementById("CurrentRoomLabel");
    const messageContainer = document.getElementById("MessagesContainer");
    const inputField = document.getElementById("MessageInput");

    // Estado
    let currentUserId = null;
    let currentRoomId = null;
    let currentRoomName = null;

    socket.emit("registerClientType", "web");

    function TryLogin() {
      loginErrorMessage.textContent = "";

      if (!usernameField.value || !passwordField.value) {
        loginErrorMessage.textContent = "User or password is blank";
        return;
      }
      const loginData = { username: usernameField.value, password: passwordField.value };
      socket.emit("LoginRequest", loginData);
    }

    socket.on("LoginResponse", (loginResponseData) => {
      const isSuccess =
        loginResponseData &&
        (loginResponseData.status === "success" || loginResponseData.statues === "success");

      if (!isSuccess) {
        const errorMessage = (loginResponseData && loginResponseData.message) || "Unknown";
        loginErrorMessage.textContent = errorMessage;
        return;
      }

      currentUserId = loginResponseData.id;
      loggedUser.textContent = `Usuario: ${usernameField.value} (id: ${currentUserId})`;

      userInfo.hidden = false;
      loginContainer.hidden = true;

      // Mostrar selector de salas y pedir listado
      roomsContainer.hidden = false;
      chatContainer.hidden = true;
      socket.emit("requestRooms");
    });

    socket.on("roomsInfo", (rooms) => {
      // Si ya está en una sala, no mostrar listado
      if (currentRoomId) {
        roomsContainer.hidden = true;
        return;
      }
      roomsList.innerHTML = "";
      rooms.forEach((r) => {
        const li = document.createElement("li");
        li.textContent = `${r.name} (id=${r.id})`;

        const btn = document.createElement("button");
        btn.textContent = "Join";
        btn.onclick = () => joinRoom(r.id, r.name);

        li.appendChild(btn);
        roomsList.appendChild(li);
      });
    });

    function joinRoom(roomId, roomName) {
      currentRoomId = roomId;
      currentRoomName = roomName;

      socket.emit(
        "joinRoom",
        JSON.stringify({
          roomId: roomId,
          playerId: currentUserId,
          playerName: usernameField.value,
        })
      );

      // Oculta selector de salas cuando ya estás en una
      roomsContainer.hidden = true;

      // Cargar histórico de esta sala y mostrar chat
      currentRoomLabel.textContent = `Room: ${currentRoomName} (id=${currentRoomId})`;
      messageContainer.innerHTML = "";
      socket.emit("ClientRequestMessageListToServer", JSON.stringify({ roomId }));
      chatContainer.hidden = false;
      inputField.focus();
    }

    function LeaveRoom() {
      if (!currentRoomId) return;
      socket.emit("leaveRoom", JSON.stringify({ roomId: currentRoomId, playerId: currentUserId }));
      currentRoomId = null;
      currentRoomName = null;

      // Limpiar UI de chat y volver al listado de salas
      currentRoomLabel.textContent = "";
      messageContainer.innerHTML = "";
      chatContainer.hidden = true;

      // Mostrar de nuevo el selector de salas sin desloguear
      roomsContainer.hidden = false;
      socket.emit("requestRooms");
    }

    function Logout() {
      // Si estás en una sala, abandónala
      if (currentRoomId) {
        socket.emit("leaveRoom", JSON.stringify({ roomId: currentRoomId, playerId: currentUserId }));
      }
      socket.emit("LogoutRequest", { userId: currentUserId });

      // Reset UI
      userInfo.hidden = true;
      chatContainer.hidden = true;
      roomsContainer.hidden = true;

      loginContainer.hidden = false;
      currentUserId = null;
      currentRoomId = null;
      currentRoomName = null;
      usernameField.value = "";
      passwordField.value = "";
      messageContainer.innerHTML = "";
    }

    function SendMessage() {
      const text = inputField.value && inputField.value.trim();
      if (!text || !currentRoomId || !currentUserId) return;

      const messageData = {
        userId: currentUserId,
        roomId: currentRoomId,
        username: usernameField.value,
        text: text,
      };

      socket.emit("ClientMessageToServer", JSON.stringify(messageData));
      inputField.value = "";
      inputField.focus();
    }

    function CreateMessageWithData(messageData) {
      const msgParagraph = document.createElement("p");
      msgParagraph.textContent = `${messageData.username}: ${messageData.text}`;

      if (messageData.username === usernameField.value) {
        msgParagraph.classList.add("MyMessage");
      } else {
        msgParagraph.classList.add("OthersMessage");
      }

      messageContainer.appendChild(msgParagraph);
      messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    socket.on("ServerMessageToClient", (messageData) => {
      // Ignorar mensajes de otras salas
      if (messageData.roomId && currentRoomId && messageData.roomId !== currentRoomId) return;
      CreateMessageWithData(messageData);
    });

    socket.on("ServerResponseRequestMessageListToClient", (msgDataList) => {
      messageContainer.innerHTML = "";
      for (const messageData of msgDataList) {
        CreateMessageWithData(messageData);
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") SendMessage();
      if (e.key === "Escape") LeaveRoom(); // ahora ESC solo sale de la sala
    });
  </script>
</html>