<!DOCTYPE html>
<html class="FullScreenObject">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat En Clase</title>
        <link rel="stylesheet" href="/styles.css">
    </head>
    
    <body class="FullScreenObject">
        <!-- LOGIN SECTION -->
        <div id="LoginContainer" class="LoginSection">
            <div class="LoginBox">
                <h1>Chat En Clase</h1>
                <div class="FormGroup">
                    <label for="UsernameInput">Username:</label>
                    <input type="text" id="UsernameInput" placeholder="Enter your username" />
                </div>
                <div class="FormGroup">
                    <label for="PasswordInput">Password:</label>
                    <input type="password" id="PasswordInput" placeholder="Enter your password" />
                </div>
                <p id="LoginErrorMessage" class="ErrorMessage"></p>
                <button onclick="TryLogin()" class="PrimaryButton">Login</button>
            </div>
        </div>

        <!-- USER INFO & LOGOUT -->
        <div id="UserInfo" class="UserInfoBar" hidden>
            <div class="UserInfoContent">
                <p id="LoggedUser" class="UserLabel"></p>
                <button id="LogoutBtn" onclick="Logout()" class="DangerButton">Logout</button>
            </div>
        </div>

        <!-- ROOMS SECTION -->
        <div id="RoomsContainer" class="RoomsSection" hidden>
            <div class="RoomsBox">
                <h2>Salas de Chat</h2>
                <div class="CreateRoomForm">
                    <input type="text" id="RoomNameInput" placeholder="Nombre de la nueva sala..." />
                    <button onclick="CreateRoom()" class="PrimaryButton">Crear Sala</button>
                </div>
                <div id="RoomList" class="RoomListContainer"></div>
            </div>
        </div>

        <!-- CHAT CONTAINER -->
        <div class="ChatContainer" id="ChatContainer" hidden>
            <!-- Chat Header -->
            <div class="ChatHeader">
                <span id="CurrentRoomLabel" class="RoomTitle"></span>
                <button id="LeaveRoomBtn" class="DangerButton" onclick="LeaveRoom()">Salir de sala</button>
            </div>

            <!-- Messages Area -->
            <div id="MessagesContainer" class="MessagesContainer"></div>

            <!-- Input Area -->
            <div class="InputContainer">
                <input type="text" id="MessageInput" class="MessageInput" placeholder="Escribe tu mensaje..." />
                <button onclick="SendMessage()" class="MessageButton">Enviar</button>
            </div>
        </div>
    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        var socket = io();

        // DOM Elements
        var loginContainer = document.getElementById("LoginContainer");
        var usernameField = document.getElementById("UsernameInput");
        var passwordField = document.getElementById("PasswordInput");
        var loginErrorMessage = document.getElementById("LoginErrorMessage");

        var userInfo = document.getElementById("UserInfo");
        var loggedUserLabel = document.getElementById("LoggedUser");

        var roomsContainer = document.getElementById("RoomsContainer");
        var roomNameInput = document.getElementById("RoomNameInput");
        var roomList = document.getElementById("RoomList");

        var chatContainer = document.getElementById("ChatContainer");
        var currentRoomLabel = document.getElementById("CurrentRoomLabel");

        var messageContainer = document.getElementById("MessagesContainer");
        var inputField = document.getElementById("MessageInput");

        var currentUser = { id: null, username: null };
        var currentRoomId = null;

        // Create message UI using the requested format: "[username]: [mensaje]"
        function CreateMessageWithData(messageData){
            var text = messageData.text || messageData.content || "";
            var senderUsername = messageData.username || (messageData.user_id ? ("user#" + messageData.user_id) : "unknown");

            // single-line message element showing "[username]: [mensaje]"
            var line = document.createElement("div");
            line.className = "MessageLine";

            // Build the displayed text exactly in the requested format
            line.textContent = "[" + senderUsername + "]: " + text;

            // mark ownership for alignment/styling
            if (senderUsername === usernameField.value) {
                line.classList.add("MyMessage");
            } else {
                line.classList.add("OthersMessage");
            }

            messageContainer.appendChild(line);
            // keep scroll at the bottom
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        socket.on("ServerMessageToClient", (messageData) => {
            CreateMessageWithData(messageData);
        });

        socket.on("ServerResponseRequestMessageListToClient", (msgDataList) => {
            messageContainer.innerHTML = "";
            for(messageData of msgDataList){
                CreateMessageWithData(messageData);
            }
        });

        function SendMessage(){
            if(!currentRoomId){
                alert("Únete a una sala primero.");
                return;
            }
            if(inputField.value.trim()){
                var text = inputField.value;
                var messageData = {
                    roomId: currentRoomId,
                    content: text
                };
                socket.emit("ClientMessageToServer", messageData);
                inputField.value = "";
                inputField.focus();
            }
        }

        // Rooms rendering
        socket.on("ChatRoomsData", (rooms) => {
            roomList.innerHTML = "";
            if(!rooms || rooms.length === 0){
                var p = document.createElement("p");
                p.className = "NoRoomsMessage";
                p.textContent = "No hay salas disponibles.";
                roomList.appendChild(p);
                return;
            }

            var ul = document.createElement("ul");
            ul.className = "RoomsList";
            rooms.forEach(r => {
                var li = document.createElement("li");
                li.className = "RoomItem";
                
                var roomInfo = document.createElement("div");
                roomInfo.className = "RoomInfo";
                roomInfo.innerHTML = `<strong>#${r.id}</strong> - ${r.name}`;
                
                var btn = document.createElement("button");
                btn.className = "JoinButton";
                btn.textContent = "Unirse";
                btn.onclick = () => JoinRoom(r.id);

                li.appendChild(roomInfo);
                li.appendChild(btn);
                ul.appendChild(li);
            });
            roomList.appendChild(ul);
        });

        function JoinRoom(roomId){
            socket.emit("JoinRoomRequest", { roomId: roomId });
        }

        let isPlayer = false;

        socket.on("JoinRoomResponse", (data) => {
            if(data.status === "success"){
                currentRoomId = data.roomId;
                isPlayer = (data.role === "player");
                chatContainer.hidden = false;
                currentRoomLabel.textContent = "Sala #" + currentRoomId;
                socket.emit("ClientRequestMessageListToServer", { roomId: currentRoomId });
            }else{
                alert(data.message || "No se pudo unir a la sala");
            }
        });

        function CreateRoom(){
            var name = (roomNameInput.value || "").trim();
            if(!name){
                alert("El nombre de la sala es requerido");
                return;
            }
            socket.emit("CreateRoomRequest", { name: name });
        }

        socket.on("CreateRoomResponse", (res) => {
            if(res.status === "success"){
                roomNameInput.value = "";
            }else{
                alert(res.message || "Error al crear la sala");
            }
        });

        // Keyboard input for players
        document.addEventListener("keydown", function (e) {
            if (!isPlayer || !currentRoomId) return;

            const active = document.activeElement;
            if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) return;

            let action = null;
            switch (e.code) {
                case "KeyA": action = "left"; break;
                case "KeyD": action = "right"; break;
                case "Space": action = "rotate"; break;
                case "KeyS": action = "softDropStart"; break;
            }
            if (action) {
                socket.emit("GameInput", { roomId: currentRoomId, action });
                if (e.code === "Space") e.preventDefault();
            }
        });

        document.addEventListener("keyup", function (e) {
            if (!isPlayer || !currentRoomId) return;

            const active = document.activeElement;
            if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) return;

            if (e.code === "KeyS") {
                socket.emit("GameInput", { roomId: currentRoomId, action: "softDropEnd" });
            }
        });

        function TryLogin(){
            loginErrorMessage.textContent = "";

            if(usernameField.value.trim() == "" || passwordField.value == ""){
                loginErrorMessage.textContent = "El usuario o la contraseña están vacíos";
                return;
            }

            var loginData = {
                username: usernameField.value,
                password: passwordField.value
            };

            socket.emit("LoginRequest", loginData);
        }

        socket.on("LoginResponse", (loginResponseData) => {
            if(loginResponseData.status == "error"){
                var errorMessage = loginResponseData.message || "Error desconocido";
                loginErrorMessage.textContent = errorMessage;
                return;
            }

            currentUser.id = loginResponseData.id;
            currentUser.username = loginResponseData.username || usernameField.value;

            loggedUserLabel.textContent = "Sesión iniciada como: " + currentUser.username;
            userInfo.hidden = false;

            loginContainer.hidden = true;
            roomsContainer.hidden = false;

            console.log(loginResponseData);
        });

        function LeaveRoom() {
            if (!currentRoomId) return;
            socket.emit("leaveRoom", JSON.stringify({ roomId: currentRoomId, playerId: currentUser.id }));
            chatContainer.hidden = true;
            currentRoomLabel.textContent = "";
            currentRoomId = null;
            messageContainer.innerHTML = "";
        }

        function Logout() {
            if (currentRoomId) {
                LeaveRoom();
            }

            socket.emit("LogoutRequest", { userId: currentUser.id });

            userInfo.hidden = true;
            chatContainer.hidden = true;
            roomsContainer.hidden = true;

            loginContainer.hidden = false;

            currentUser.id = null;
            currentUser.username = null;

            usernameField.value = "";
            passwordField.value = "";
            messageContainer.innerHTML = "";
            loginErrorMessage.textContent = "";
        }

        // Allow sending message with Enter key
        inputField.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                SendMessage();
            }
        });

    </script>

</html>